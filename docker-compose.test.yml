# docker-compose.test.yml
# Entorno Aislado para Pruebas Automatizadas

services:
  # --- Base de Datos de Pruebas (Efímera) ---
  db_test:
    image: postgres:16-alpine
    container_name: astruxa_db_test
    env_file: .env.test
    ports:
      - "5434:5432" # Puerto distinto al de desarrollo
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d astruxa_test_db"]
      interval: 2s
      timeout: 5s
      retries: 10

  # --- Ejecutor de Pruebas (Pytest) ---
  test_runner:
    build: .
    container_name: astruxa_test_runner
    env_file: .env.test
    environment:
      - POSTGRES_HOST=db_test
    volumes:
      - .:/app # Montamos código para ver cambios sin reconstruir
    command: pytest -v
    depends_on:
      db_test:
        condition: service_healthy
