# docker-compose.test.yml
# Entorno Aislado para Pruebas Automatizadas

services:
  # --- Base de Datos de Pruebas (Efímera) ---
  db_test:
    # CORRECCIÓN: Usar TimescaleDB en lugar de Postgres puro
    image: timescale/timescaledb:latest-pg16
    container_name: astruxa_db_test
    env_file: .env.test
    ports:
      - "5434:5432" # Puerto distinto al de desarrollo
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d astruxa_test_db"]
      interval: 2s
      timeout: 5s
      retries: 10

  # --- Redis de Pruebas ---
  redis_test: # Este nombre debe coincidir con REDIS_HOST en .env.test
    image: redis:alpine
    container_name: astruxa_redis_test
    ports:
      - "6380:6379" # Puerto distinto al de desarrollo
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 5

  # --- Servidor de Correo Mock (Mailpit) ---
  mock: # Este nombre debe coincidir con SMTP_HOST en .env.test
    image: axllent/mailpit
    container_name: astruxa_mock_mail
    ports:
      - "8026:8025" # UI en puerto diferente
      - "1026:1025" # SMTP en puerto diferente

  # --- Ejecutor de Pruebas (Pytest) ---
  test_runner:
    build: .
    container_name: astruxa_test_runner
    env_file: .env.test
    environment:
      - POSTGRES_HOST=db_test
      - REDIS_HOST=redis_test # Asegurar que apunte al servicio correcto
      - SMTP_HOST=mock 
    volumes:
      - .:/app # Montamos código para ver cambios sin reconstruir
    # Ejecutar migraciones Y SEEDING antes de los tests
    command: sh -c "alembic upgrade head && python -m app.db.seeding.seed_all && pytest -v"
    depends_on:
      db_test:
        condition: service_healthy
      redis_test:
        condition: service_healthy
      mock:
        condition: service_started
